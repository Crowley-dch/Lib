{% extends 'base.html' %}
{% load static %}

{% block title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - Librio{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 2.2em;
        font-weight: bold;
        color: var(--primary-color);
        margin: 10px 0;
    }
    
    .stat-label {
        color: var(--light-text);
        font-size: 0.95em;
    }
    
    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 30px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--light-bg);
    }
    
    .progress-bar {
        height: 8px;
        background: var(--light-bg);
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 30px;">
    <h1 style="margin: 0;">üìä –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    <p style="color: var(--light-text); margin-top: 5px;">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã Librio</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö -->
<div class="dashboard-grid">
    <div class="stat-card">
        <div class="stat-icon">üìö</div>
        <div class="stat-number">{{ total_books }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∫–Ω–∏–≥</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-number">{{ total_users }}</div>
        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">‚úçÔ∏è</div>
        <div class="stat-number">{{ total_authors }}</div>
        <div class="stat-label">–ê–≤—Ç–æ—Ä–æ–≤</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üìñ</div>
        <div class="stat-number">{{ active_loans }}</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–¥–∞—á</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-number">{{ loans_last_week }}</div>
        <div class="stat-label">–í—ã–¥–∞—á –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    </div>
</div>

<!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–∏–ø–∞–º -->
<div class="section">
    <div class="section-title">
        <span style="font-size: 1.5em;">üë•</span>
        <h2 style="margin: 0;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
    </div>

    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th>–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                    <th>–î–æ–ª—è</th>
                </tr>
            </thead>
            <tbody>
                {% for item in users_by_type %}
                <tr>
                    <td>
                        {% if item.user_type == 'admin' %}
                            <span style="margin-right: 8px;">üëë</span> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                        {% elif item.user_type == 'librarian' %}
                            <span style="margin-right: 8px;">üìö</span> –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å
                        {% elif item.user_type == 'teacher' %}
                            <span style="margin-right: 8px;">üë®‚Äçüè´</span> –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
                        {% elif item.user_type == 'student' %}
                            <span style="margin-right: 8px;">üéì</span> –°—Ç—É–¥–µ–Ω—Ç
                        {% else %}
                            {{ item.user_type }}
                        {% endif %}
                    </td>
                    <td><strong>{{ item.count }}</strong></td>
                     <td>
                        {% if item.percentage %}
                            {{ item.percentage }}%
                        {% else %}
                            {% widthratio item.count total_users 100 %}%
                        {% endif %}
                    </td>
                    <td style="width: 150px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:
                                {% if item.percentage %}
                                    {{ item.percentage }}%
                                {% else %}
                                    {% widthratio item.count total_users 100 %}%
                                {% endif %}
                            "></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ö–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä–∞–º -->
<div class="section">
    <div class="section-title">
        <span style="font-size: 1.5em;">üìö</span>
        <h2 style="margin: 0;">–ö–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä–∞–º (–¢–æ–ø-5)</h2>
    </div>

    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th>–ñ–∞–Ω—Ä</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥</th>
                    <th>–î–æ–ª—è</th>
                </tr>
            </thead>
            <tbody>
                {% for item in books_by_genre %}
                <tr>
                    <td><strong>{{ item.genre__name }}</strong></td>
                    <td>{{ item.count }}</td>
                    <td style="width: 150px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {% widthratio item.count total_books 100 %}%"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏ –≤—ã–¥–∞—á–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
<div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–Ω–∏–≥–∏ -->
    <div>
        <div class="section-title">
            <span style="font-size: 1.5em;">üÜï</span>
            <h3 style="margin: 0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏</h3>
        </div>

        <div class="card">
            {% for book in recent_books %}
            <div style="padding: 12px 0; {% if not forloop.last %}border-bottom: 1px solid var(--light-bg);{% endif %}">
                <a href="{% url 'book_detail' book.id %}" style="color: inherit; text-decoration: none; display: block;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ book.title|truncatechars:40 }}</strong>
                            <div style="font-size: 0.9em; color: var(--light-text); margin-top: 3px;">
                                {{ book.author.full_name }}
                            </div>
                        </div>
                        <span class="badge {% if book.access_level == 'free' %}badge-success{% else %}badge-warning{% endif %}" style="font-size: 0.8em;">
                            {{ book.get_access_level_display }}
                        </span>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–¥–∞—á–∏ -->
    <div>
        <div class="section-title">
            <span style="font-size: 1.5em;">üîÑ</span>
            <h3 style="margin: 0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥</h3>
        </div>

        <div class="card">
            {% for loan in recent_loans %}
            <div style="padding: 12px 0; {% if not forloop.last %}border-bottom: 1px solid var(--light-bg);{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ loan.user.username }}</strong>
                        <div style="font-size: 0.9em; color: var(--light-text); margin-top: 3px;">
                            ID –∫–Ω–∏–≥–∏: {{ loan.book_id }}
                        </div>
                    </div>
                    <span class="badge
                        {% if loan.status == 'active' %}badge-success
                        {% elif loan.status == 'overdue' %}badge-danger
                        {% else %}badge-info{% endif %}" style="font-size: 0.8em;">
                        {{ loan.get_status_display }}
                    </span>
                </div>
                <div style="font-size: 0.85em; color: var(--light-text); margin-top: 5px;">
                    {{ loan.loan_date|date:"d.m.Y H:i" }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="section" style="margin-top: 30px;">
    <div class="section-title">
        <span style="font-size: 1.5em;">‚ö°</span>
        <h2 style="margin: 0;">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
    </div>

    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <a href="{% url 'add_book' %}" class="card" style="text-align: center; text-decoration: none; color: inherit; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚ûï</div>
            <strong>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</strong>
        </a>

        <a href="/admin/" target="_blank" class="card" style="text-align: center; text-decoration: none; color: inherit; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">üëë</div>
            <strong>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Django</strong>
        </a>

        <a href="{% url 'manage_books' %}" class="card" style="text-align: center; text-decoration: none; color: inherit; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">üìö</div>
            <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏</strong>
        </a>

        <a href="{% url 'book_list' %}" class="card" style="text-align: center; text-decoration: none; color: inherit; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">üîç</div>
            <strong>–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞</strong>
        </a>
    </div>
</div>
{% endblock %}