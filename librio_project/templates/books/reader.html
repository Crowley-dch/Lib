{% extends 'base.html' %}
{% load static %}

{% block title %}–ß—Ç–µ–Ω–∏–µ: {{ book.title }} - Librio{% endblock %}

{% block extra_css %}
<style>
    .reader-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .book-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .book-content {
        font-family: 'Georgia', serif;
        font-size: 18px;
        line-height: 1.8;
        text-align: justify;
        min-height: 500px;
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);

        /* –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–±–∞–∑–æ–≤–∞—è) */
        user-select: none;
        -webkit-user-select: none;
    }

    .page-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding: 15px;
        background: var(--light-bg);
        border-radius: 8px;
    }

    .watermark {
        position: fixed;
        bottom: 10px;
        right: 10px;
        opacity: 0.1;
        font-size: 12px;
        color: #000;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="reader-container">
    <div class="book-header">
        <h1>{{ book.title }}</h1>
        <p><em>{{ book.author.full_name }}</em></p>
        <div class="badge badge-success">
            üìñ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_num }} –∏–∑ {{ total_pages }}
        </div>
    </div>

    <div class="book-content" id="book-text">
        {{ current_page|linebreaks }}
    </div>

    <div class="page-navigation">
        {% if page_num > 1 %}
        <a href="?page={{ page_num|add:'-1' }}" class="btn">
            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        </a>
        {% else %}
        <span></span>
        {% endif %}

        <div>
            <form method="get" style="display: inline;">
                <input type="number" name="page" min="1" max="{{ total_pages }}"
                       value="{{ page_num }}" style="width: 60px;">
                <button type="submit" class="btn">–ü–µ—Ä–µ–π—Ç–∏</button>
            </form>
        </div>

        {% if page_num < total_pages %}
        <a href="?page={{ page_num|add:'1' }}" class="btn">
            –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí
        </a>
        {% else %}
        <span></span>
        {% endif %}
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <a href="{% url 'book_detail' book.id %}" class="btn">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–∏—Å–∞–Ω–∏—é –∫–Ω–∏–≥–∏
        </a>

        {% if user.userprofile.user_type in 'admin,librarian'|split:',' %}
        <a href="/admin/books/bookcontent/{{ book.content.id }}/change/"
           class="btn btn-warning" target="_blank">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
        </a>
        {% endif %}
    </div>
</div>

<div class="watermark">
    User: {{ user.id }} | Book: {{ book.id }} | Page: {{ page_num }} | Date: {% now "Y-m-d H:i:s" %}
</div>

<script>
// –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const bookText = document.getElementById('book-text');

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫
    bookText.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showMessage('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ');
    });

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (—á–∞—Å—Ç–∏—á–Ω–æ)
    bookText.addEventListener('selectstart', function(e) {
        e.preventDefault();
    });

    // –ë–ª–æ–∫–∏—Ä—É–µ–º Ctrl+C, Ctrl+S
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 'c' || e.key === 's' || e.key === 'p')) {
            e.preventDefault();
            showMessage('–î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ');
        }

        // –°–æ—á–µ—Ç–∞–Ω–∏—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º
        if (e.key === 'ArrowLeft' && {{ page_num }} > 1) {
            window.location.href = `?page={{ page_num|add:"-1" }}`;
        }
        if (e.key === 'ArrowRight' && {{ page_num }} < {{ total_pages }}) {
            window.location.href = `?page={{ page_num|add:"1" }}`;
        }
    });

    function showMessage(text) {
        // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π toast
        alert(text);
    }
});
</script>
{% endblock %}